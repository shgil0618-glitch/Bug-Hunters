<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="~{fragments/layout}">
<body>
	<div layout:fragment="content">

		<h2 class="mb-4">마이페이지</h2>

		<div th:if="${successMessage}"
			class="alert alert-info alert-dismissible fade show">
			<span th:text="${successMessage}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>

		<div sec:authorize="isAuthenticated()">
			<div class="p-3">
				<table class="table table-bordered align-middle">
					<tbody>
						<tr>
							<td rowspan="8" class="text-center table-primary"
								style="width: 25%"><img
								th:if="${dto != null and dto.ufile != null}"
								th:src="@{'/upload/' + ${dto.ufile}}" style="width: 300px" /> <img
								th:if="${dto == null or dto.ufile == null}"
								th:src="@{'/upload/no.png'}" style="width: 300px" /></td>
						</tr>
						<tr>
							<th>닉네임</th>
							<td th:text="${dto.nickname}"></td>
						</tr>
						<tr>
							<th>휴대폰</th>
							<td th:text="${dto.mobile}"></td>
						</tr>
						<tr>
							<th>주소</th>
							<td
								th:text="${(dto.address ?: '') + ' ' + (dto.detailAddress ?: '')}"></td>
						</tr>
						<tr>
							<th>가입일</th>
							<td th:text="${dto.createdAt}"></td>
						</tr>
						<tr>
							<th>로그인 방식</th>
							<td th:text="${dto.provider}"></td>
						</tr>
					</tbody>
				</table>
			</div>

			<div class="mt-3">
				<a th:href="@{/users/update}" class="btn btn-primary"> 정보 수정 </a>

				<form th:action="@{/users/delete}" method="post" class="d-inline"
					onsubmit="return confirm('정말 탈퇴하시겠습니까?');">
					<input type="hidden" th:name="${_csrf.parameterName}"
						th:value="${_csrf.token}" />
					<button type="submit" class="btn btn-danger">회원 탈퇴</button>
				</form>

				<div sec:authorize="hasRole('ADMIN')" class="d-inline">
					<button type="button" class="btn btn-warning"
						onclick="openAdminModal()">회원 활동 관리</button>
				</div>
			</div>
		</div>

		<div class="modal fade" id="adminModal" tabindex="-1"
			aria-hidden="true">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header bg-dark text-white">
						<h5 class="modal-title">전체 회원 상태 관리</h5>
						<button type="button" class="btn-close btn-close-white"
							data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body" id="adminModalBody">
						<div class="text-center p-5">로딩 중...</div>
					</div>
				</div>
			</div>
		</div>

		<script th:inline="javascript">
			// 1. 모달 열기 및 내용 로드
			function openAdminModal() {
				const modalElement = document.getElementById('adminModal');
				const adminModal = new bootstrap.Modal(modalElement);
				adminModal.show();
				loadAdminData();
			}

			// 2. 관리자 데이터 로드 함수 (새로고침 시 호출)
			function loadAdminData() {
				fetch('/admin/user-status')
					.then(res => res.text())
					.then(html => {
						const body = document.getElementById('adminModalBody');
						body.innerHTML = html;
						bindFormEvents(body); // 로드된 폼들에 이벤트 연결
					})
					.catch(err => console.error('로드 실패:', err));
			}

			// 3. 폼 제출 이벤트 가로채기 (페이지 이동 방지)
			function bindFormEvents(container) {
				const forms = container.querySelectorAll('form');
				forms.forEach(form => {
					form.addEventListener('submit', function(e) {
						e.preventDefault(); // 🛑 실제 페이지 이동 방지
						
						const formData = new FormData(this);
						const url = this.getAttribute('action');

						fetch(url, {
							method: 'POST',
							body: formData,
							headers: { 'X-Requested-With': 'XMLHttpRequest' }
						})
						.then(res => {
							if(res.ok) {
								alert('성공적으로 처리되었습니다.');
								loadAdminData(); // 🔄 팝업 내용은 유지하고 데이터만 새로고침
							} else {
								alert('처리에 실패했습니다.');
							}
						})
						.catch(err => console.error('전송 에러:', err));
					});
				});
			}
		</script>
	</div>
</body>
</html>