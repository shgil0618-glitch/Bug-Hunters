<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thejoa703.dao.UserStatusDao">

    <select id="findAllUserStatus" resultType="com.thejoa703.dto.AdminUserStatusDto">
        SELECT
            a.APPUSERID AS appUserId,
            a.EMAIL AS email,
            a.NICKNAME AS nickname,
            a.PROVIDER AS provider,
            m.STATUS AS status,
            m.SUSPEND_REASON AS suspendReason,
            m.SUSPEND_UNTIL AS suspendUntil
        FROM
            BUG3_MANAGE m
        JOIN BUG3 a ON m.APPUSERID = a.APPUSERID
        ORDER BY
            m.UPDATED_AT DESC
    </select>

    <select id="findByAppUserId" parameterType="int" resultType="com.thejoa703.dto.UserStatusDto">
        SELECT
            APPUSERID AS appUserId,
            STATUS AS status,
            SUSPEND_REASON AS suspendReason,
            SUSPEND_UNTIL AS suspendUntil,
            UPDATED_AT AS updatedAt
        FROM 
            BUG3_MANAGE
        WHERE 
            APPUSERID = #{appUserId}
    </select>

    <update id="recoverExpiredSuspension" parameterType="int">
        UPDATE BUG3_MANAGE
        SET
            STATUS = 'ACTIVE',
            SUSPEND_REASON = NULL,
            SUSPEND_UNTIL = NULL,
            UPDATED_AT = SYSDATE
        WHERE 
            APPUSERID = #{appUserId}
            AND STATUS = 'SUSPEND'
            AND SUSPEND_UNTIL <![CDATA[ < ]]> SYSDATE
    </update>

    <insert id="insert" parameterType="com.thejoa703.dto.UserStatusDto">
        INSERT INTO BUG3_MANAGE (
            APPUSERID,
            STATUS,
            SUSPEND_REASON,
            SUSPEND_UNTIL,
            UPDATED_AT
        )
        VALUES (
            #{appUserId, jdbcType=INTEGER},
            #{status, jdbcType=VARCHAR},
            #{suspendReason, jdbcType=VARCHAR},
            #{suspendUntil, jdbcType=DATE},
            SYSDATE
        )
    </insert>

    <update id="update" parameterType="com.thejoa703.dto.UserStatusDto">
        UPDATE BUG3_MANAGE
        <set>
            <if test="status != null"> STATUS = #{status}, </if>
            <if test="suspendReason != null"> SUSPEND_REASON = #{suspendReason}, </if>
            <if test="suspendUntil != null"> SUSPEND_UNTIL = #{suspendUntil}, </if>
            <if test="suspendReason == null"> SUSPEND_REASON = NULL, </if>
            <if test="suspendUntil == null"> SUSPEND_UNTIL = NULL, </if>
            UPDATED_AT = SYSDATE
        </set>
        WHERE APPUSERID = #{appUserId, jdbcType=INTEGER}
    </update>

    <select id="findAllAdminUserStatus" resultType="com.thejoa703.dto.AdminUserStatusDto">
        SELECT
            u.APPUSERID AS appUserId,
            u.STATUS AS status,
            u.SUSPEND_REASON AS suspendReason,
            u.SUSPEND_UNTIL AS suspendUntil,
            u.UPDATED_AT AS updatedAt,
            a.EMAIL AS email,
            a.NICKNAME AS nickname
        FROM
            BUG3_MANAGE u
        JOIN BUG3 a ON u.APPUSERID = a.APPUSERID
        ORDER BY
            u.UPDATED_AT DESC
    </select>

    <select id="findAdminUserByAppUserId" parameterType="int" resultType="com.thejoa703.dto.AdminUserStatusDto">
        SELECT
            u.APPUSERID AS appUserId,
            u.EMAIL AS email,
            u.NICKNAME AS nickname,
            u.PROVIDER AS provider,
            s.STATUS AS status,
            s.SUSPEND_REASON AS suspendReason,
            s.SUSPEND_UNTIL AS suspendUntil
        FROM
            BUG3 u
        JOIN BUG3_MANAGE s ON u.APPUSERID = s.APPUSERID
        WHERE
            u.APPUSERID = #{appUserId}
    </select>

</mapper>